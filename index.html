<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Chrombook Helfer Bot ‚Äì v7 (Live Support Chat)</title>
  <!-- Firebase (compat) CDN ‚Äì works on GitHub Pages -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    :root{
      --bg:#0b0f19; --panel:#121a2a; --panel2:#0f1726; --border:#20304e; --text:#e9eef7; --muted:#a3b0c7;
      --accent:#6d7cff; --accent2:#00d4ff; --danger:#ff6b6b; --success:#3ddc97; --radius:16px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background: radial-gradient(1200px 800px at 10% -10%, #1b2440 0%, transparent 60%), var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, sans-serif; }
    .app{ max-width:980px; margin-inline:auto; display:flex; flex-direction:column; min-height:100dvh; padding:12px; }
    header{ position:sticky; top:0; z-index:5; background: linear-gradient(135deg, rgba(109,124,255,.25), rgba(0,212,255,.12)), var(--panel); border:1px solid var(--border); border-radius:14px; padding:8px 10px; }
    .row{ display:flex; align-items:center; gap:10px; }
    .sp{ flex:1; }
    .logo{ display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit; user-select:none; }
    .logo svg{ width:32px; height:32px; border-radius:8px; }
    .title{ font-weight:700; }
    button{ font:inherit; color:var(--text); background: linear-gradient(180deg,#1b2440,#121a2a); border:1px solid var(--border); padding:10px 14px; border-radius:12px; cursor:pointer; }
    button:hover{ filter:brightness(1.06); }
    .ghost{ background:transparent; border-color:var(--border); }
    .cards{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:10px; }
    @media (min-width:680px){ .cards{ grid-template-columns:repeat(4,1fr); } }
    .card{ border:1px solid var(--border); background: linear-gradient(180deg,var(--panel),var(--panel2)); border-radius:16px; padding:12px; }
    .card h4{ margin:0 0 6px; font-size:14px; color:#c9d7ff; }
    .card p{ margin:0 0 8px; font-size:13px; color:var(--muted); }
    .chatWrap{ margin-top:10px; border:1px solid var(--border); border-radius:16px; background: linear-gradient(180deg,#0e152b,#0b1120); }
    .chatTabs{ display:flex; gap:8px; padding:8px; border-bottom:1px solid var(--border); }
    .tab{ padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:linear-gradient(180deg,#121a2a,#0f1726); cursor:pointer; font-size:14px; }
    .tab.active{ outline:2px solid rgba(109,124,255,.5); }
    .modeInfo{ margin-left:auto; font-size:12px; color:var(--muted); display:flex; align-items:center; gap:8px; }
    .dot{ width:8px; height:8px; border-radius:50%; background:#666; display:inline-block; }
    .dot.live{ background:#3ddc97; box-shadow:0 0 0 4px rgba(61,220,151,.12); }
    .chat{ padding:12px; display:flex; flex-direction:column; gap:10px; min-height:44dvh; }
    .msg{ display:flex; gap:8px; align-items:flex-start; }
    .msg .bubble{ background: linear-gradient(180deg,#121a2a,#0f1726); border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-size:14px; line-height:1.4; white-space:pre-wrap; }
    .msg.user .bubble{ background: linear-gradient(180deg,#0f1524,#0a0f19); }
    .avatar{ width:30px; height:30px; border-radius:50%; display:grid; place-items:center; background: radial-gradient(circle at 35% 35%, #9bb3ff, #6d7cff 40%, #0b0f19 70%); border:1px solid rgba(255,255,255,.12); }
    .composer{ position:sticky; bottom:0; display:flex; gap:8px; border-top:1px solid var(--border); padding:8px; background: linear-gradient(180deg,#0b1120,#0b1120); border-radius:0 0 16px 16px; }
    .composer input{ flex:1; border:1px solid var(--border); border-radius:10px; padding:12px 12px; background:#0b1120; color:#e9eef7; }
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:14px; background: rgba(0,0,0,.6); border:1px solid var(--border); padding:10px 12px; border-radius:12px; z-index:40; }
    .fab{ position:fixed; right:16px; bottom:84px; width:56px; height:56px; border-radius:50%; display:grid; place-items:center; background: linear-gradient(135deg, rgba(109,124,255,.85), rgba(0,212,255,.65)); border:1px solid rgba(255,255,255,.18); z-index:15; }
    .badge{ position:absolute; top:-6px; right:-6px; min-width:18px; height:18px; padding:0 5px; display:grid; place-items:center; background: var(--danger); color:white; border-radius:999px; font-size:11px; font-weight:700; border:1px solid rgba(255,255,255,.35); }
    /* Modals */
    .modal-backdrop{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; padding:16px; background: rgba(0,0,0,.55); z-index:20; }
    .modal{ width:min(780px,96vw); background: linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--border); border-radius:16px; padding:14px; }
    .modal input, .modal textarea{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0b1120; color:#e9eef7; }
    .rowbtn{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .hidden{ display:none !important; }
    .meta{ font-size:12px; color:var(--muted); }
    .ticket{ border:1px solid var(--border); border-radius:12px; padding:10px; background: linear-gradient(180deg,#0f1526,#0c1222); margin-top:8px; }
    .tag{ display:inline-block; border:1px solid var(--border); border-radius:999px; padding:2px 8px; font-size:11px; color:#c9d7ff; }
    .thread{ max-height:38vh; overflow:auto; border:1px solid var(--border); border-radius:12px; padding:10px; background: linear-gradient(180deg,#0f1526,#0c1222); }
    .tmsg{ display:flex; gap:8px; margin-bottom:8px; }
    .tmsg .who{ font-weight:700; font-size:12px; color:#c9d7ff; min-width:100px; }
    .tmsg .txt{ white-space:pre-wrap; }
    .right{ justify-content: flex-end; }
    noscript{ display:block; background:#331; color:#fff; padding:10px; border-radius:8px; margin-top:10px; }
  </style>
</head>
<body>
  <noscript>JavaScript ist deaktiviert. Bitte in Chrome aktivieren ‚Äì sonst funktioniert der Bot nicht.</noscript>
  <div class="app">
    <header>
      <div class="row">
        <a href="#" class="logo" id="logo" title="Chrombook Helfer">
          <svg viewBox="0 0 64 64" aria-hidden="true">
            <defs><radialGradient id="lg" cx="50%" cy="50%" r="70%">
              <stop offset="0%" stop-color="#cfe3ff"/><stop offset="40%" stop-color="#7ea3ff"/><stop offset="100%" stop-color="#0a0f1d"/></radialGradient></defs>
            <rect width="64" height="64" rx="12" fill="url(#lg)"/>
            <g opacity="0.9"><circle cx="16" cy="18" r="2" fill="white"/><circle cx="46" cy="14" r="1.2" fill="white"/><circle cx="40" cy="34" r="1.1" fill="white"/><circle cx="24" cy="48" r="1.2" fill="white"/></g>
            <path d="M10 50 Q32 30 54 50" stroke="#7ef3ff" stroke-width="2" fill="none" opacity="0.8"/>
          </svg>
          <div>
            <div class="title">Chrombook&nbsp;Helfer</div>
            <div class="meta">Galaxy ‚Ä¢ Dark</div>
          </div>
        </a>
        <div class="sp"></div>
        <button id="contactBtn" title="Mitarbeiter kontaktieren">Kontakt ‚Ä¢ Mitarbeiter</button>
        <button id="logoutBtn" class="ghost hidden" title="Mitarbeiter abmelden">Abmelden</button>
      </div>
    </header>

    <section class="cards" id="cards">
      <div class="card"><h4>üöÄ Erste Schritte</h4><p>Chromebook Basics & Shortcuts.</p><button data-intent="shortcuts">Tastenk√ºrzel</button></div>
      <div class="card"><h4>‚öôÔ∏è Leistung</h4><p>Langsam? So wird‚Äôs flotter.</p><button data-intent="speed">Schneller machen</button></div>
      <div class="card"><h4>üêß Linux & Dev</h4><p>Linux aktivieren & apt.</p><button data-intent="linux">Linux installieren</button></div>
      <div class="card"><h4>üõçÔ∏è Apps</h4><p>Play-Store & PWAs.</p><button data-intent="apps">Apps & Spiele</button></div>
    </section>

    <section class="chatWrap">
      <div class="chatTabs">
        <button class="tab" id="tabBot">ü§ñ Bot</button>
        <button class="tab" id="tabStaff">üë®‚Äçüíª Mitarbeiter</button>
        <div class="modeInfo"><span class="dot" id="liveDot"></span><span id="modeLabel">Offline</span></div>
      </div>
      <section class="chat" id="chat" aria-live="polite" aria-label="Chatverlauf"></section>
      <form class="composer" id="composer" autocomplete="off">
        <input id="input" type="text" placeholder="Nachricht schreiben ‚Ä¶" />
        <button id="send" type="submit">Senden ‚ñ∂</button>
      </form>
    </section>
  </div>

  <!-- FAB: Chat-Center (Staff-only) -->
  <div class="fab hidden" id="fab" title="Chat-Center (Mitarbeiter)">
    üí¨ <span class="badge hidden" id="badge">0</span>
  </div>

  <!-- Kontakt -->
  <div class="modal-backdrop hidden" id="contactModal">
    <div class="modal">
      <h3>üëã Mitarbeiter kontaktieren</h3>
      <label for="contactMsg">Nachricht</label>
      <textarea id="contactMsg" rows="4" placeholder="Worum geht es?"></textarea>
      <div class="rowbtn">
        <button id="cancelContact" type="button">Abbrechen</button>
        <button id="sendContact" type="button">Absenden</button>
      </div>
    </div>
  </div>

  <!-- Tickets (Staff) -->
  <div class="modal-backdrop hidden" id="ticketsModal">
    <div class="modal">
      <h3>üí¨ Chat-Center <span class="meta" id="openCount">(0 offen)</span></h3>
      <div id="ticketsList"></div>
      <div class="rowbtn">
        <button id="closeTickets" type="button">Schlie√üen</button>
      </div>
    </div>
  </div>

  <!-- Reply (Staff) -->
  <div class="modal-backdrop hidden" id="replyModal">
    <div class="modal">
      <h3>Thread <span class="meta" id="replyTicketId"></span></h3>
      <div class="thread" id="thread"></div>
      <textarea id="replyText" rows="3" placeholder="Antwort schreiben ‚Ä¶"></textarea>
      <div class="rowbtn">
        <button id="replyBack" type="button">Zur√ºck</button>
        <button id="replyResolve" type="button">Als erledigt</button>
        <button id="sendReply" type="button">Antwort senden</button>
      </div>
    </div>
  </div>

  <!-- Login -->
  <div class="modal-backdrop hidden" id="loginModal">
    <div class="modal">
      <div id="step1">
        <h3>üîí Geheim: Mitarbeiter-Login (1/3)</h3>
        <input id="code1" type="password" placeholder="Code 1" />
        <div class="rowbtn"><button id="cancelLogin" type="button">Abbrechen</button><button id="next1" type="button">Weiter</button></div>
      </div>
      <div id="step2" class="hidden">
        <h3>üìß E-Mail (2/3)</h3>
        <input id="email" type="email" placeholder="komplette Mitarbeiter-E-Mail" />
        <p class="meta">Hinweis: <strong>J1339K</strong> ‚Äì gib deine komplette E-Mail ein.</p>
        <div class="rowbtn"><button id="back1" type="button">Zur√ºck</button><button id="next2" type="button">Weiter</button></div>
      </div>
      <div id="step3" class="hidden">
        <h3>üîë Zweiter Code (3/3)</h3>
        <input id="code2" type="password" placeholder="TT.MM.JJJJ" />
        <div class="rowbtn"><button id="back2" type="button">Zur√ºck</button><button id="finishLogin" type="button">Anmelden</button></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

  <script>
  document.addEventListener('DOMContentLoaded', function(){
    // Firebase config (provided by you)
    const firebaseConfig = {
      apiKey: "AIzaSyDN1MZv_q38Zoymt92BHWTe9sUNwteT1KA",
      authDomain: "sample-firebase-ai-app-b02a4.firebaseapp.com",
      projectId: "sample-firebase-ai-app-b02a4",
      storageBucket: "sample-firebase-ai-app-b02a4.firebasestorage.app",
      messagingSenderId: "382050648468",
      appId: "1:382050648468:web:8c6f34051a7b2991ebcf81"
    };

    // Helpers
    const $ = (s, r=document)=> r.querySelector(s);
    const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));
    const hide = el => el.classList.add('hidden');
    const show = el => el.classList.remove('hidden');
    const toast = (t,ms=2200)=>{ const e=$('#toast'); e.textContent=t; show(e); setTimeout(()=>hide(e),ms); };
    const fmt = t=> new Date(t).toLocaleString('de-DE',{year:'2-digit',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
    const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
    const load = (k,d)=> { try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; } };
    const uid = ()=> Math.random().toString(36).slice(2,10);
    const deviceId = load('cbh_device') || (save('cbh_device','dev-'+uid()), load('cbh_device'));

    // State
    const liveDot = $('#liveDot'), modeLabel = $('#modeLabel');
    let botChat = load('cbh_bot_chat', []);
    let tickets = [];           // from Firestore or local
    let staff = sessionStorage.getItem('cbh_staff')==='1';
    let activeTicketId = load('cbh_active_ticket', null);
    let mode = load('cbh_mode', 'bot'); // 'bot' | 'staff'

    // DOM
    const chatEl = $('#chat'), input = $('#input');
    const cards = $('#cards');
    const contactBtn = $('#contactBtn'), badge = $('#badge');
    const fab = $('#fab');
    const contactModal = $('#contactModal'), contactMsg = $('#contactMsg');
    const ticketsModal = $('#ticketsModal'), ticketsList = $('#ticketsList'), openCount = $('#openCount');
    const closeTicketsBtn = $('#closeTickets');
    const replyModal = $('#replyModal'), thread = $('#thread'), replyText = $('#replyText'), replyTicketId = $('#replyTicketId');
    const sendReply = $('#sendReply'), replyBack = $('#replyBack'), replyResolve = $('#replyResolve');
    const loginModal = $('#loginModal'), code1 = $('#code1'), email = $('#email'), code2 = $('#code2');
    const next1=$('#next1'), next2=$('#next2'), finishLogin=$('#finishLogin'), cancelLogin=$('#cancelLogin'), back1=$('#back1'), back2=$('#back2');
    const logo = $('#logo'), logoutBtn = $('#logoutBtn');
    const tabBot = $('#tabBot'), tabStaff = $('#tabStaff');

    // Firebase
    const FB = { enabled:false, app:null, db:null, auth:null, unsub:null };
    try{
      FB.app = firebase.initializeApp(firebaseConfig);
      FB.auth = firebase.auth();
      FB.db = firebase.firestore();
      FB.auth.signInAnonymously().then(()=>{
        FB.enabled = true;
        liveDot.classList.add('live'); modeLabel.textContent='Live';
        subscribeTickets();
      }).catch(e=>{ console.error(e); modeLabel.textContent='Offline'; });
    }catch(e){ console.error('Firebase init failed', e); modeLabel.textContent='Offline'; }

    // Rendering
    function renderBotChat(){
      chatEl.innerHTML = '';
      for(const m of botChat){
        const wrap = document.createElement('div');
        wrap.className = 'msg ' + (m.role==='user'?'user':'bot');
        const avatar = document.createElement('div'); avatar.className='avatar'; avatar.textContent = m.role==='user'?'üë§':'ü§ñ';
        const bubble = document.createElement('div'); bubble.className='bubble'; bubble.textContent = m.text;
        const meta = document.createElement('div'); meta.className='meta'; meta.textContent = (m.role==='user'?'Du':'Helfer')+' ‚Ä¢ '+fmt(m.time);
        const col = document.createElement('div'); col.appendChild(bubble); col.appendChild(meta);
        wrap.appendChild(avatar); wrap.appendChild(col); chatEl.appendChild(wrap);
      }
      chatEl.scrollTop = chatEl.scrollHeight;
      save('cbh_bot_chat', botChat);
    }
    function renderStaffChat(){
      chatEl.innerHTML = '';
      let t = tickets.find(x=>x.id===activeTicketId);
      if(!t){
        // fallback: pick most recent by this device
        const my = tickets.filter(x=>x.from===deviceId).sort((a,b)=> (b.time||0)-(a.time||0));
        if(my[0]){ activeTicketId = my[0].id; save('cbh_active_ticket', activeTicketId); t = my[0]; }
      }
      if(!t){
        chatEl.innerHTML = '<div class="meta">Kein aktiver Mitarbeiter-Chat. Starte einen Kontakt oben √ºber ‚ÄûKontakt ‚Ä¢ Mitarbeiter‚Äú.</div>';
        return;
      }
      // Header line
      const hdr = document.createElement('div');
      hdr.className = 'meta';
      hdr.textContent = 'Chat mit Mitarbeiter ‚Ä¢ Ticket ' + t.id + (t.status==='erledigt'?' (erledigt)':'');
      chatEl.appendChild(hdr);
      // Messages
      const msgs = Array.isArray(t.messages)? t.messages : [];
      for(const m of msgs){
        const wrap = document.createElement('div');
        wrap.className = 'msg ' + (m.by==='user'?'user':'bot');
        const avatar = document.createElement('div'); avatar.className='avatar'; avatar.textContent = m.by==='user'?'üë§':'üë®‚Äçüíª';
        const bubble = document.createElement('div'); bubble.className='bubble'; bubble.textContent = m.text;
        const meta = document.createElement('div'); meta.className='meta'; meta.textContent = (m.by==='user'?'Du':'Mitarbeiter')+' ‚Ä¢ '+fmt(m.time);
        const col = document.createElement('div'); col.appendChild(bubble); col.appendChild(meta);
        wrap.appendChild(avatar); wrap.appendChild(col); chatEl.appendChild(wrap);
      }
      chatEl.scrollTop = chatEl.scrollHeight;
    }
    function renderChat(){
      tabBot.classList.toggle('active', mode==='bot');
      tabStaff.classList.toggle('active', mode==='staff');
      if(mode==='bot') renderBotChat(); else renderStaffChat();
      save('cbh_mode', mode);
    }

    // KB for bot
    const KB = [
      {p:['hallo','hi','hey','moin','gr√º√ü'], r:'Hey! üëã Ich bin dein Chrombook-Helfer. Frag mich alles zu Chromebook, Linux, Apps & Leistung. ‚ú®'},
      {p:['tasten','shortcut','k√ºrzel','kombination'], r:'‚å®Ô∏è Shortcuts:\n‚Ä¢ Screenshot: Strg+‚ñ¢||\n‚Ä¢ Bereich: Strg+Umschalt+‚ñ¢||\n‚Ä¢ Tab neu/schlie√üen: Strg+T / Strg+W\n‚Ä¢ Task-Manager: Such + Esc üôÇ'},
      {p:['linux','crostini'], r:'üêß Linux: Einstellungen ‚Üí Entwickler ‚Üí Linux aktivieren. Dann: sudo apt update && sudo apt upgrade -y ‚Ä¢ sudo apt install git curl build-essential -y'},
      {p:['langsam','leistung','ruckelt','lag'], r:'‚ö° Schneller machen: Tabs/Erweiterungen pr√ºfen, Speicher aufr√§umen, Hardwarebeschleunigung aktivieren (Chrome ‚Üí System), Neustart/Powerwash als letzter Schritt.'},
      {p:['apps','play','android'], r:'üì± Apps: Einstellungen ‚Üí Apps ‚Üí Play-Store aktivieren ‚Üí im Store installieren. Viele Dienste auch als PWA verf√ºgbar. üõçÔ∏è'},
      {p:['druck','drucker','pdf'], r:'üñ®Ô∏è Drucken/PDF: Druck-Dialog ‚Üí ‚ÄûAls PDF speichern‚Äú oder Drucker unter Einstellungen ‚Üí ‚ÄûDrucker‚Äú hinzuf√ºgen. üìÑ'},
      {p:['hilfe','mitarbeiter','kontakt'], r:'ü§ù Wenn du pers√∂nliche Hilfe brauchst: Wechsel oben auf ‚Äûüë®‚Äçüíª Mitarbeiter‚Äú oder nutze ‚ÄûKontakt ‚Ä¢ Mitarbeiter‚Äú. Wir sind da!'},
    ];
    function botAnswer(q){
      const s = (q||'').toLowerCase();
      for(const e of KB){ if(e.p.some(x=>s.includes(x))) return e.r + ' ‚ú®'; }
      return 'Ich bin mir nicht sicher. ü§î‚û°Ô∏è Ich verweise dich an einen Mitarbeiter. Wechsle auf ‚Äûüë®‚Äçüíª Mitarbeiter‚Äú. üôå';
    }

    // Tickets helpers
    function normalizeDoc(docId, d){
      const messages = Array.isArray(d.messages) ? d.messages.slice() : [];
      // Migrate legacy: initial message + replies -> messages
      if(messages.length===0){
        if(d.message){ messages.push({by:'user', text:d.message, time: d.time || Date.now()}); }
        if(Array.isArray(d.replies)){ for(const r of d.replies){ messages.push({by:'staff', text:r.text, time:r.time || Date.now()}); } }
      }
      return {
        id: docId, from: d.from, time: d.time || 0, status: d.status || 'offen',
        message: d.message || (messages[0]?.text || ''),
        messages
      };
    }

    async function createTicket(message){
      // create Firestore ticket with messages array
      const ref = await FB.db.collection('cbh_tickets').add({
        from: deviceId,
        message,
        time: Date.now(),
        status: 'offen',
        messages: [{ by:'user', text: message, time: Date.now() }]
      });
      activeTicketId = ref.id; save('cbh_active_ticket', activeTicketId);
      mode = 'staff'; renderChat();
      toast('Ticket erstellt und Mitarbeiter-Chat ge√∂ffnet ‚úÖ');
    }
    async function sendToStaff(text){
      if(!activeTicketId){ await createTicket(text); return; }
      await FB.db.collection('cbh_tickets').doc(activeTicketId).update({
        messages: firebase.firestore.FieldValue.arrayUnion({ by:'user', text, time: Date.now() })
      });
    }

    // Composer
    $('#composer').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const val = (input.value||'').trim(); if(!val) return;
      if(val === '/login'){ openLogin(); input.value=''; return; }
      if(mode==='bot'){
        botChat.push({role:'user', text: val, time: Date.now()});
        renderBotChat();
        setTimeout(()=>{
          botChat.push({role:'bot', text: botAnswer(val), time: Date.now()});
          renderBotChat();
        }, 150);
      }else{
        if(!FB.enabled){ toast('Live-Chat offline. Bitte Internet pr√ºfen.'); input.value=''; return; }
        await sendToStaff(val);
      }
      input.value='';
    });

    // Tabs
    tabBot.addEventListener('click', ()=>{ mode='bot'; renderChat(); });
    tabStaff.addEventListener('click', ()=>{ mode='staff'; renderChat(); });

    // Cards ‚Üí prefill to bot
    $('#cards').addEventListener('click', (e)=>{
      const b = e.target.closest('button[data-intent]'); if(!b) return;
      const m = {shortcuts:'Welche Tastenk√ºrzel gibt es?', speed:'Mein Chromebook ist langsam. Was tun?', linux:'Wie installiere ich Linux (Crostini)?', apps:'Wie installiere ich Apps?'}[b.dataset.intent];
      if(m){ botChat.push({role:'user', text:m, time:Date.now()}); setTimeout(()=>{ botChat.push({role:'bot', text: botAnswer(m), time: Date.now()}); renderBotChat(); }, 150); renderBotChat(); }
    });

    // Contact flow
    function openContact(){ show(contactModal); $('#contactMsg').focus(); }
    function closeContact(){ hide(contactModal); }
    contactBtn.addEventListener('click', ()=>{ if(staff) openTickets(); else openContact(); });
    $('#cancelContact').addEventListener('click', closeContact);
    $('#sendContact').addEventListener('click', async ()=>{
      const msg = (contactMsg.value||'').trim(); if(!msg){ toast('Bitte Nachricht eingeben.'); return; }
      if(!FB.enabled){ toast('Live-Chat offline. Bitte Internet pr√ºfen.'); return; }
      await createTicket(msg);
      contactMsg.value=''; closeContact();
      mode='staff'; renderChat();
    });

    // Staff Chat-Center
    function openTickets(){ renderTickets(); show(ticketsModal); }
    function closeTicketsModal(){ hide(ticketsModal); }
    $('#closeTickets').addEventListener('click', closeTicketsModal);
    $('#ticketsList').addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-act]'); if(!btn) return;
      const id = btn.dataset.id; const act = btn.dataset.act;
      if(act==='resolve'){ await FB.db.collection('cbh_tickets').doc(id).update({status:'erledigt'}); }
      if(act==='delete'){ await FB.db.collection('cbh_tickets').doc(id).delete(); }
      if(act==='reply'){ activeTicketId = id; save('cbh_active_ticket', id); openReply(id); }
    });
    function renderTickets(){
      ticketsList.innerHTML = '';
      if(tickets.length===0){ ticketsList.innerHTML = '<p class="meta">Keine Anfragen vorhanden.</p>'; return; }
      for(const t of tickets){
        const lastMsg = (t.messages && t.messages.length) ? t.messages[t.messages.length-1] : null;
        const preview = lastMsg ? (lastMsg.by==='staff'?'üë®‚Äçüíª ':'üë§ ') + escapeHTML(lastMsg.text).slice(0,80) : escapeHTML(t.message).slice(0,80);
        const el = document.createElement('div');
        el.className = 'ticket';
        el.innerHTML = `
          <div><strong>Ticket:</strong> ${t.id} ‚Ä¢ <span class="tag">${t.status}</span></div>
          <div class="meta">Von: ${t.from} ‚Ä¢ ${fmt(t.time)}</div>
          <div style="margin:6px 0 8px; white-space:pre-wrap;">${preview}</div>
          <div class="rowbtn">
            <button data-act="reply" data-id="${t.id}">√ñffnen</button>
            <button data-act="resolve" data-id="${t.id}">Als erledigt</button>
            <button data-act="delete" data-id="${t.id}">L√∂schen</button>
          </div>`;
        ticketsList.appendChild(el);
      }
      // badge/open count (staff only)
      const open = tickets.filter(t=>t.status==='offen').length;
      $('#openCount').textContent = '('+open+' offen)';
      if(staff){ if(open>0){ $('#badge').textContent=String(open); show($('#badge')); } else hide($('#badge')); }
    }
    function escapeHTML(s){ return (s||'').replace(/[&<>]/g, t => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[t])); }

    // Reply modal (staff)
    function openReply(id){
      const t = tickets.find(x=>x.id===id); if(!t) return;
      $('#replyTicketId').textContent = '#'+t.id;
      renderThread(t);
      replyText.value='';
      show(replyModal);
    }
    function closeReply(){ hide(replyModal); }
    replyBack.addEventListener('click', ()=>{ closeReply(); openTickets(); });
    replyResolve.addEventListener('click', async ()=>{
      const id = activeTicketId; if(!id) return;
      await FB.db.collection('cbh_tickets').doc(id).update({status:'erledigt'});
      toast('Ticket erledigt ‚úÖ'); renderTickets(); closeReply();
    });
    sendReply.addEventListener('click', async ()=>{
      const txt = (replyText.value||'').trim(); if(!txt){ toast('Bitte eine Antwort schreiben.'); return; }
      await FB.db.collection('cbh_tickets').doc(activeTicketId).update({
        messages: firebase.firestore.FieldValue.arrayUnion({ by:'staff', text: txt, time: Date.now() })
      });
      replyText.value='';
    });
    function renderThread(t){
      thread.innerHTML = '';
      const msgs = Array.isArray(t.messages)? t.messages : [];
      for(const m of msgs){
        const d = document.createElement('div');
        d.className = 'tmsg ' + (m.by==='staff'?'right':'');
        d.innerHTML = `<div class="who">${m.by==='staff'?'Mitarbeiter':'Kunde'}</div><div class="txt">${escapeHTML(m.text)}<div class="meta">${fmt(m.time)}</div></div>`;
        thread.appendChild(d);
      }
      thread.scrollTop = thread.scrollHeight;
    }

    // Realtime subscription
    function subscribeTickets(){
      if(FB.unsub){ try{ FB.unsub(); }catch{} FB.unsub=null; }
      let q;
      if(staff){ q = FB.db.collection('cbh_tickets').orderBy('time','desc').limit(200); }
      else     { q = FB.db.collection('cbh_tickets').where('from','==',deviceId); }
      FB.unsub = q.onSnapshot(async (snap)=>{
        const arr = [];
        const toMigrate = [];
        snap.forEach(doc=>{
          const d = doc.data() || {};
          const n = normalizeDoc(doc.id, d);
          arr.push(n);
          if(!Array.isArray(d.messages)){ toMigrate.push({id:doc.id, n}); }
        });
        tickets = arr;
        // perform one-time migrations (legacy -> messages)
        for(const m of toMigrate){
          try{
            await FB.db.collection('cbh_tickets').doc(m.id).update({ messages: m.n.messages });
          }catch(e){ /* ignore */ }
        }
        if(mode==='staff') renderStaffChat();
        if(staff) renderTickets();
      }, (err)=>{
        console.error('snapshot error', err);
        modeLabel.textContent='Fehler';
        liveDot.classList.remove('live');
      });
    }

    // Secret login: Ctrl+Alt+# OR triple-click logo OR /login
    function openLogin(){ show(loginModal); hide($('#step2')); hide($('#step3')); show($('#step1')); setTimeout(()=>code1.focus(), 50); }
    function closeLogin(){ hide(loginModal); }
    let logoClicks = 0, logoTimer = null;
    logo.addEventListener('click', ()=>{
      logoClicks++;
      if(logoTimer) clearTimeout(logoTimer);
      logoTimer = setTimeout(()=>{ logoClicks=0; }, 500);
      if(logoClicks>=3){ openLogin(); logoClicks=0; }
    });
    window.addEventListener('keydown', (e)=>{
      const isHash = e.key === '#' || e.code === 'Backslash' || (e.code==='Digit3' && (e.altKey||e.ctrlKey));
      if(e.ctrlKey && e.altKey && isHash){ e.preventDefault(); openLogin(); }
      if(e.key==='Escape'){ hide(contactModal); hide(loginModal); hide(ticketsModal); hide(replyModal); }
    });
    cancelLogin.addEventListener('click', closeLogin);
    next1.addEventListener('click', ()=>{
      if(code1.value.trim()==='140318'){ hide($('#step1')); show($('#step2')); email.focus(); } else toast('Falscher Code.');
    });
    next2.addEventListener('click', ()=>{
      if((email.value||'').trim().toLowerCase()==='julian1339klausch@gmx.de'){ hide($('#step2')); show($('#step3')); code2.focus(); } else toast('E-Mail stimmt nicht.');
    });
    back1.addEventListener('click', ()=>{ hide($('#step2')); show($('#step1')); });
    back2.addEventListener('click', ()=>{ hide($('#step3')); show($('#step2')); });
    finishLogin.addEventListener('click', ()=>{
      if(code2.value.trim()==='11.09.2000'){ sessionStorage.setItem('cbh_staff','1'); staff=true; applyStaffUI(); toast('Mitarbeiter-Modus aktiviert üõ°Ô∏è'); closeLogin(); subscribeTickets(); }
      else toast('Falscher zweiter Code.');
    });

    // Staff UI
    function applyStaffUI(){
      if(staff){
        contactBtn.textContent = 'Chat-Center';
        contactBtn.title = 'Chat-Center √∂ffnen';
        show(logoutBtn);
        show(fab);
      }else{
        contactBtn.textContent = 'Kontakt ‚Ä¢ Mitarbeiter';
        contactBtn.title = 'Mitarbeiter kontaktieren';
        hide(logoutBtn);
        hide(fab);
      }
    }
    logoutBtn.addEventListener('click', ()=>{
      staff = false;
      sessionStorage.removeItem('cbh_staff');
      applyStaffUI();
      toast('Abgemeldet.');
      subscribeTickets(); // switch to user scope
    });

    // FAB (staff only): open chat center
    fab.addEventListener('click', ()=>{ if(staff) openTickets(); });

    // First run UX
    if(!load('cbh_seen_v7', false)){
      botChat.push({role:'bot', text:'Willkommen! ‚ú® Du kannst oben zwischen ü§ñ Bot und üë®‚Äçüíª Mitarbeiter umschalten. Wenn du ‚ÄûMitarbeiter kontaktieren‚Äú nutzt, √∂ffnet sich direkt der Live-Chat. ü§ù', time: Date.now()});
      save('cbh_seen_v7', true);
    }

    // Initial render
    applyStaffUI();
    renderChat();

    // Focus input
    setTimeout(()=> input.focus(), 200);
  });
  </script>
</body>
</html>
